# Repository Guidelines

## Project Structure & Module Organization
- Browser extension lives in `src/`:
  - `extension.ts`: Content script that builds the overlay, toolbar, and wires tools together.
  - `drawing.ts`: Canvas draw logic; listens for pointer events and renders strokes.
  - `notes.ts`: Note and highlight helpers; reacts to selection and double-clicks.
  - `messages.ts`: Message types shared between the content script and background worker.
  - `bookmark.ts`: Background service worker that toggles saved state, updates the action icon, and relays save/unsave requests.
  - `api.ts`: Content-side helper for calling the Next API (requires stored auth token).
  - `styles.css`: Visuals for overlay, toolbar, and notes.
- `manifest.json`: MV3 manifest pointing to the bundled content script, background worker, and CSS.
- `dist/`: esbuild output for the extension; regenerated by scripts, never edited directly.
- Next app/UI lives in `app/` (API routes and stub UI).
- Server utilities and schemas live in `server/` (Supabase client, auth guard, HTTP helpers, zod schemas).
- Database schema in `supabase/schema.sql`.
- TypeScript runs in `strict` mode via `tsconfig.json`; path alias `@/*` resolves from repo root.

## Build, Test, and Development Commands
- Install once: `npm install`.
- Extension build: `npm run build` (bundles `src/extension.ts` and `src/bookmark.ts` to `dist/`, copies `manifest.json`, `styles.css`, and icons).
- Extension dev loop: `npm run watch` (auto-rebundle on save).
- Load extension: Chrome → Extensions → Load unpacked → select `dist/`.
- Next dev server: `npm run dev` (requires env set; serves API routes and future UI).
- Next production build: `npm run build:next` then `npm start`.
- Required env for Next/Supabase: `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY`.

## Coding Style & Naming Conventions
- TypeScript-first; keep explicit types on exported helpers and DOM handlers.
- Two-space indentation; keep lines readable (<100 chars when possible).
- Prefer small, single-purpose helpers over large event handlers; avoid mutating shared state across modules.
- DOM ids/classes for annotator UI use the `annotator-` prefix to avoid host-page collisions.
- Run `npm run build` for extension changes and `npm run build:next` for server/UI changes before sharing updates.

## Testing Guidelines
- No automated tests yet; rely on manual smoke tests.
- Extension: verify drawing start/stop, stroke color/width, highlighting selections, adding notes, window resize, tool toggling, and bookmark icon state (saved/unsaved) across navigation.
- API: `GET /api/health` returns `{ ok: true }`; `POST /api/items` saves/upsserts a page for an authenticated user (Bearer token from Supabase).
- If you add tests, colocate them (e.g., `src/extension.spec.ts`) and document how to run them.

## Commit & Pull Request Guidelines
- Commits: concise imperative mood (e.g., “Add stroke throttling”); group related edits.
- PRs include: summary of behavior changes, screenshots/GIFs for UI, and manual test notes.
- Keep generated `dist/` diffs minimal; reviewers focus on `src/` and configs. Note which build command you ran.

## Security & Configuration Tips
- Content script matches `<all_urls>`; avoid network calls or persisting sensitive data.
- Keep overlay isolated with high `z-index` and scoped selectors; do not override host page styles unless necessary.
- Extension auth token is stored in `chrome.storage.local`; only send it to the API domain.
